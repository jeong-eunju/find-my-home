{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "---\n",
        "title: \"Ames Housing Dashboard\"\n",
        "format: dashboard\n",
        "page-navigation: true\n",
        "---\n",
        "\n",
        "\n",
        "::: {.column-page}\n",
        "\n",
        "## Lasso ë¶„ì„\n"
      ],
      "id": "71ca67ec"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "import numpy as np\n",
        "import pandas as pd\n",
        "pd.set_option('display.max_rows', None)\n",
        "df = pd.read_excel('../find-my-home/ames_df.xlsx')\n",
        "\n",
        "# ì „ì²˜ë¦¬###############################################################\n",
        "# ìˆ˜ì¹˜í˜• ë³€ìˆ˜ qual, cond ê°€ì¤‘ì¹˜ì¤˜ì„œ ìƒˆë¡œìš´ ì—´ ì¶”ê°€\n",
        "# ê°€ì¤‘ì¹˜ ì£¼ê¸° ìœ„í•´ ìƒê´€ê³„ìˆ˜ ë¶„ì„\n",
        "df[['SalePrice', 'OverallQual', 'OverallCond']].corr()  ## Qualì´ ìƒê´€ê³„ìˆ˜ ë†’ê²Œ ë‚˜ì™€ Qualê°€ì¤‘ì¹˜ë¥¼ 7ë¡œ ì¤Œ\n",
        "\n",
        "# Overall ì ìˆ˜ ê³„ì‚° (OverallQual 70%, OverallCond 30%)\n",
        "df['Overall'] = df['OverallQual'] * 0.7 + df['OverallCond'] * 0.3\n",
        "df\n",
        "\n",
        "\n",
        "# ë²”ì£¼í˜• ë³€ìˆ˜ qual, cond ê°€ì¤‘ì¹˜ì¤˜ì„œ ìƒˆë¡œìš´ ì—´ ì¶”ê°€\n",
        "# ì ìˆ˜í™” ê¸°ì¤€ (543210 ìŠ¤ì¼€ì¼)\n",
        "qual_map_543210 = {\n",
        "    'Ex': 5,\n",
        "    'Gd': 4,\n",
        "    'TA': 3,\n",
        "    'Fa': 2,\n",
        "    'Po': 1,\n",
        "    'None': 0,\n",
        "    'nan': 0,\n",
        "    '0': 0\n",
        "}\n",
        "\n",
        "# ëŒ€ìƒ ë³€ìˆ˜\n",
        "qual_vars = [\n",
        "    \"ExterQual\", \"ExterCond\",\n",
        "    \"BsmtQual\", \"BsmtCond\",\n",
        "    \"HeatingQC\",\n",
        "    \"GarageQual\", \"GarageCond\"\n",
        "]\n",
        "\n",
        "\n",
        "\n",
        "for col in qual_vars:\n",
        "    df[col] = df[col].astype(str).replace(['nan', 'NaN', '0'], 'None')  # ì˜ˆì™¸ì²˜ë¦¬ ê°•í™”\n",
        "    df[col + \"_Score\"] = df[col].map(qual_map_543210)\n",
        "\n",
        "# ê²°ê³¼ ì¼ë¶€ í™•ì¸\n",
        "df[[col + \"_Score\" for col in qual_vars]]\n",
        "\n",
        "# í€„ë¦¬í‹° ìƒê´€ê´€ê³„ í™•ì¸\n",
        "df[[\"SalePrice\", \"OverallQual\", \"OverallCond\"]].corr()\n",
        "df[[\"SalePrice\", \"ExterQual_Score\", \"ExterCond_Score\"]].corr()\n",
        "df[[\"SalePrice\", \"GarageQual_Score\", \"GarageCond_Score\"]].corr()\n",
        "df[[\"SalePrice\", \"BsmtQual_Score\", \"BsmtCond_Score\"]].corr()\n",
        "\n",
        "# ë²”ì£¼í˜• ë°ì´í„° ê°€ì¤‘ì¹˜ ì—´ ì¶”ê°€\n",
        "df['Exter'] = df['ExterQual_Score'] * 0.9 + df['ExterCond_Score'] * 0.1\n",
        "df['Garage'] = df['GarageQual_Score'] * 0.7 + df['GarageCond_Score'] * 0.3\n",
        "df[\"Bsmt\"] = df[\"BsmtQual_Score\"] * 0.7 + df[\"BsmtCond_Score\"] * 0.3\n",
        "df.info()\n",
        "\n",
        "cols_to_drop = [\n",
        "    'OverallQual', 'OverallCond',\n",
        "    'ExterQual', 'ExterCond',\n",
        "    'BsmtQual', 'BsmtCond',\n",
        "    'GarageQual', 'GarageCond',\n",
        "    'ExterQual_Score', 'ExterCond_Score',\n",
        "    'BsmtQual_Score', 'BsmtCond_Score',\n",
        "    'GarageQual_Score', 'GarageCond_Score'\n",
        "]\n",
        "\n",
        "df = df.drop(columns=cols_to_drop)\n",
        "\n",
        "\n",
        "# ì˜ˆì‚° í•„í„°ë§\n",
        "df = df[df['SalePrice'] >= 130000]\n",
        "df = df[df['SalePrice'] <= 200000]\n",
        "\n",
        "# x, y ë¶„ë¦¬! \n",
        "X = df.drop(columns='SalePrice')\n",
        "y = (df['SalePrice'])\n",
        "\n",
        "# X -> ìˆ˜ì¹˜í˜•, ë²”ì£¼í˜• ë¶„ë¦¬\n",
        "num_columns = X.select_dtypes(include=['number']).columns\n",
        "cat_columns = X.select_dtypes(include=['object']).columns\n",
        "\n",
        "# ë²”ì£¼í˜•ì€ ì›í•«, ìˆ˜ì¹˜í˜•ì€ ìŠ¤ì¼€ì¼ë§ \n",
        "from sklearn.preprocessing import OneHotEncoder\n",
        "from sklearn.preprocessing import StandardScaler\n",
        "onehot = OneHotEncoder(handle_unknown='ignore', \n",
        "                       sparse_output=False)\n",
        "X_train_cat = onehot.fit_transform(X[cat_columns])\n",
        "\n",
        "std_scaler = StandardScaler()\n",
        "X_train_num = std_scaler.fit_transform(X[num_columns])\n",
        "\n",
        "X_train_all = np.concatenate([X_train_num, X_train_cat], axis = 1)\n",
        "\n",
        "\n",
        "# LassoCV -> ê°€ê²©ì— ë§ì€ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ë³€ìˆ˜ ì°¾ê¸°\n",
        "from sklearn.linear_model import LassoCV\n",
        "from sklearn.preprocessing import StandardScaler\n",
        "from sklearn.pipeline import make_pipeline\n",
        "from sklearn.model_selection import train_test_split\n",
        "\n",
        "alpha = np.linspace(0, 0.5, 1000)\n",
        "lasso_cv = LassoCV(alphas=alpha,\n",
        "                   cv=5,\n",
        "                   max_iter=1000)\n",
        "lasso_cv.fit(X_train_all, y)\n",
        "lasso_cv.alpha_     # ì•„ë˜ ê³„ì‚°í•œ ê²ƒë“¤ í‰ê· ë‚´ì„œ ìµœì ì˜ ëŒë‹¤ê°’ ì°¾ì€ ê²ƒ\n",
        "lasso_cv.mse_path_\n",
        "lasso_cv_coef = lasso_cv.coef_\n",
        "\n",
        "# 1. ì›í•« ë²”ì£¼í˜• ë³€ìˆ˜ ì´ë¦„ ë½‘ê¸°\n",
        "cat_feature_names = onehot.get_feature_names_out(cat_columns)\n",
        "\n",
        "# 2. ì „ì²´ ë³€ìˆ˜ ì´ë¦„ (ìˆ˜ì¹˜í˜• + ë²”ì£¼í˜•)\n",
        "feature_names = np.concatenate([num_columns, cat_feature_names])\n",
        "\n",
        "# 3. LassoCVì—ì„œ ë‚˜ì˜¨ ê³„ìˆ˜ì™€ ë³€ìˆ˜ì´ë¦„ ë§¤ì¹­\n",
        "lasso_coef = lasso_cv.coef_\n",
        "\n",
        "# 4. DataFrameìœ¼ë¡œ ì •ë¦¬ + ì ˆëŒ€ê°’ ê¸°ì¤€ ì •ë ¬\n",
        "coef_df = pd.DataFrame({\n",
        "    'Feature': feature_names,\n",
        "    'Coefficient': lasso_coef\n",
        "})\n",
        "coef_df['AbsCoefficient'] = coef_df['Coefficient'].abs()\n",
        "coef_df = coef_df.sort_values('AbsCoefficient', ascending=False)\n",
        "\n",
        "print(coef_df)\n",
        "\n",
        "# 0ì¸ ê°’ ì œê±°\n",
        "coef_df = coef_df[coef_df['Coefficient'] != 0]\n",
        "coef_df = coef_df.sort_values('Coefficient', ascending=False)\n",
        "coef_df.shape\n",
        "\n",
        "\n",
        "# ì˜ˆì‹œ: df_sortedëŠ” Feature, Coefficient ë“±ì´ í¬í•¨ëœ ì •ë¦¬ëœ ê²°ê³¼ ë°ì´í„°í”„ë ˆì„\n",
        "coef_df['Prefix'] = coef_df['Feature'].apply(lambda x: x.split('_')[0] if '_' in x else x)\n",
        "\n",
        "# ê·¸ë£¹ë³„ë¡œ ë¬¶ê¸° (ì˜ˆ: í‰ê· /í•©ê³„/ê°¯ìˆ˜ ë“± ì§‘ê³„ë„ ê°€ëŠ¥)\n",
        "grouped = coef_df.groupby('Prefix')\n",
        "\n",
        "# ì˜ˆì‹œ: ê·¸ë£¹ë³„ Feature ê°œìˆ˜ í™•ì¸\n",
        "print(grouped.size())\n",
        "\n",
        "# ì˜ˆì‹œ: ê·¸ë£¹ë³„ Coefficient ì´í•© ë³´ê¸°   \n",
        "print(grouped['AbsCoefficient'].mean().sort_values(ascending=False))"
      ],
      "id": "227a28e2",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| echo: false\n",
        "import pandas as pd\n",
        "import matplotlib.pyplot as plt\n",
        "from sklearn.linear_model import LassoCV\n",
        "from sklearn.model_selection import train_test_split\n",
        "from sklearn.preprocessing import StandardScaler, OneHotEncoder\n",
        "import numpy as np\n",
        "\n",
        "# ë°ì´í„° ë¡œë“œ ë° ì „ì²˜ë¦¬\n",
        "# (ì´ì „ì˜ ì „ì²´ ì½”ë“œê°€ ì—¬ê¸°ì— ì‚½ì…ë  ìˆ˜ ìˆìŒ)\n",
        "\n",
        "# ì¤‘ìš”ë„ ì‹œê°í™”\n",
        "top_n = 20\n",
        "coef_df = coef_df.sort_values('Coefficient', ascending=False).head(top_n)\n",
        "plt.figure(figsize=(10, 6))\n",
        "plt.barh(coef_df['Feature'], coef_df['Coefficient'])\n",
        "plt.xlabel('Coefficient')\n",
        "plt.title('Top 20 Important Features by Lasso Regression')\n",
        "plt.gca().invert_yaxis()\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ],
      "id": "ee51ffcb",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "## í’ˆì§ˆ ì ìˆ˜ ì‚°ì ë„\n"
      ],
      "id": "4f0f30a3"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| echo: false\n",
        "import seaborn as sns\n",
        "score_vars = ['Overall', 'Exter', 'Garage', 'Bsmt']\n",
        "for var in score_vars:\n",
        "    plt.figure(figsize=(6, 4))\n",
        "    sns.scatterplot(data=df, x=var, y='SalePrice')\n",
        "    plt.title(f'{var} vs SalePrice')\n",
        "    plt.tight_layout()\n",
        "    plt.show()"
      ],
      "id": "0ec54051",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "## ìƒê´€ê³„ìˆ˜ Heatmap\n"
      ],
      "id": "78ab1197"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| echo: false\n",
        "num_columns = df.select_dtypes(include=['number']).columns.drop('SalePrice')\n",
        "top_corr_features = df[num_columns].corrwith(df['SalePrice']).abs().sort_values(ascending=False).head(10).index\n",
        "plt.figure(figsize=(10, 8))\n",
        "sns.heatmap(df[top_corr_features.to_list() + ['SalePrice']].corr(), annot=True, cmap='coolwarm')\n",
        "plt.title(\"Top Correlated Numeric Features\")\n",
        "plt.tight_layout()\n",
        "plt.show()"
      ],
      "id": "4e599b60",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "## ì§€ë„ ì‹œê°í™”\n"
      ],
      "id": "a4e86aff"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "#| echo: false\n",
        "import plotly.express as px\n",
        "fig = px.scatter_mapbox(\n",
        "    df,\n",
        "    lat=\"Latitude\",\n",
        "    lon=\"Longitude\",\n",
        "    size=\"PriceNorm\",\n",
        "    color=\"SalePrice\",\n",
        "    color_continuous_scale=\"Viridis\",\n",
        "    size_max=50,\n",
        "    zoom=11,\n",
        "    hover_name=\"Neighborhood\",\n",
        "    hover_data={\"SalePrice\": True, \"Exter\": True, \"Garage\": True, \"Bsmt\": True, \"Overall\": True},\n",
        "    title=\"ğŸ  Ames ì£¼íƒ ê°€ê²© ì§€ë„ (ì •ê·œí™”ëœ ê°€ê²© ê¸°ë°˜)\",\n",
        "    mapbox_style=\"open-street-map\"\n",
        ")\n",
        "fig.update_layout(mapbox_center={\"lat\": 42.03, \"lon\": -93.62}, mapbox_zoom=12, margin={\"r\":0,\"t\":40,\"l\":0,\"b\":0})\n",
        "fig.show()"
      ],
      "id": "85c8039d",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        ":::"
      ],
      "id": "71a562a5"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "python3",
      "language": "python",
      "display_name": "Python 3 (ipykernel)",
      "path": "C:\\Users\\USER\\AppData\\Roaming\\Python\\share\\jupyter\\kernels\\python3"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}